{# Copyright (C) 2023 Ludger Hellerhoff, ludger@cam-ai.de #}
{# This program is free software; you can redistribute it and/or #}
{# modify it under the terms of the GNU General Public License #}
{# as published by the Free Software Foundation; either version 3 #}
{# of the License, or (at your option) any later version. #}
{# This program is distributed in the hope that it will be useful, #}
{# but WITHOUT ANY WARRANTY; without even the implied warranty of #}
{# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. #}
{# See the GNU General Public License for more details. #}
{# You should have received a copy of the GNU General Public License #}
{# along with this program; if not, write to the Free Software #}
{# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA. #}

{% extends 'main/basis.html' %}
{% block content %}
{% if mayadd %}
{% if emulatestatic %}
  {% load static %}
  <script src="{% static 'camai/git/js/wstools.js' %}"></script>
  <script src="{% static 'camai/nogit/js/jquery-3.5.1.js' %}"></script>
{% else %}
  <script src="https://static.cam-ai.de/{{ version }}/camai/git/js/wstools.js"></script>
  <script src="https://static.cam-ai.de/{{ version }}/camai/nogit/js/jquery-3.5.1.min.js"></script>
{% endif %}
<div class="h4 m-2">
  <div>
    ONVIF port:
    <input class="mb-3 m-2" type="number" min="1024" max="49151" id="portinput" size="30">
  </div>
  <div>
    ONVIF Admin Username:
    <input class="mb-3 m-2" type="text" id="adminuserinput" placeholder="admin user" size="30">
  </div>
  <div>
    ONVIF Admin Password:
    <input class="mb-3 m-2" type="text" id="adminpassinput" placeholder="admin password" size="30">
  </div>
  <div>
    ONVIF IP or Address:
    <input class="mb-3 m-2" type="text" id="ipaddress" placeholder="none (search)" size="30">
  </div>
</div>
<div>
{% if user.is_superuser %}
<button class="btn btn-primary m-2 scan-button" type="button">Scan your network (may take some minutes)</button>
</div>
{% endif %}
<div class="h2 m-2 d-none" id="please_wait">
Scanning your network. Please wait a while...
</div>
<div class="container-fluid float-left">
  <div class="row" id="netlist">
  </div>
</div>
<div class="h4 m-2">
  <div>
    Username:
    <input class="mb-3 m-2" type="text" id="userinput" size="30">
  </div>
  <div>
    Password:
    <input class="mb-3 m-2" type="text" id="passinput" size="30">
  </div>
  <div>
    Camera Type:
    <span id="typespan">?</span>
  </div>
</div>
<div class="mb-3 m-2">
  <label for="camurl" class="form-label h4">Camera URL:</label>
  <textarea class="form-control" id="camurl" rows="2"></textarea>
</div>
<div>
  <button class="btn btn-primary m-2 check-button" type="button">Check connection</button>
</div>
<h4 class="m-2 d-none" id="search_result"></h4>
<div class="h4 m-2 d-none" id="codecdiv">
  Available video codecs:
  <select class="form-select m-2 w-50" id="videoselect">
  </select>
  Available audio codecs:
  <select class="form-select m-2 w-50" id="audioselect">
  </select>
  <button class="btn btn-primary m-2 install-button" type="button">Install this camera</button>
</div>

<script>

let admintoolsSocket;

let portaddr //default

let ws_scheme = window.location.protocol == "https:" ? "wss:" : "ws:";

let xresolutions;
let yresolutions;

let urlscheme = '?';

$(document).ready(function() {
  $('#portinput').val(8000);
  $('#userinput').change(function() {
    console.log('Klick');
    $('#codecdiv').addClass("d-none");
    urlstring = urlscheme.replace('{user}', $('#userinput').val()).replace('{pass}', $('#passinput').val());
    console.log(urlstring);
    $('#camurl').val(urlstring);
  });
  $('#userinput').trigger("change");
  $('#passinput').change(function() {
    $('#userinput').trigger("change");
  });
  WSAsync(
    ws_scheme + '//'
    + window.location.host
    + '/ws/admintools/'
  )
  .then((result) => {
    admintoolsSocket = result;
    $('.btn-check').click(function(){
      portaddr = parseInt($(".btn-check:checked").val());
      $('.scan-button').trigger( "click" );
    });
    $('.scan-button').click(function() {
      $('#netlist').empty();
      $('#please_wait').removeClass("d-none");
      $('.scan-button').addClass('btn-warning');
      admintoolsSocket.sendandwait({
        'command' : 'scanonvif',
        'portaddr' : parseInt($('#portinput').val()),
        'admin' : $('#adminuserinput').val(),
        'pass' : $('#adminpassinput').val(),
        'ip' : $('#ipaddress').val(),
      })  
      .then((result) => {
        $('.scan-button').removeClass('btn-warning');
        $('#please_wait').addClass("d-none");
        for (item of result) {
          newcard  = '<div class="card m-1 p-0" style="border: 1; width: 212px; height: auto;">';
            newcard += '<div class="card-body">';
              newcard += '<h5 class="card-title"><b>'+item.ip+'</b></h5>';
              newcard += '<h6 class="card-subtitle mb-2">NetName: <b>'+item.name+'</b></h6>';
              newcard += '<h6 class="card-subtitle mb-2">Manufacturer: <b>'+item.Manufacturer+'</b></h6>';
              newcard += '<h6 class="card-subtitle mb-2">Model: <b>'+item.Model+'</b></h6>';
              newcard += '<h6 class="card-subtitle mb-2">Firmware: <b>'+item.FirmwareVersion+'</b></h6>';
              newcard += '<h6 class="card-subtitle mb-2">Serial: <b>'+item.SerialNumber+'</b></h6>';
              newcard += '<h6 class="card-subtitle mb-2">HardwareID: <b>'+item.HardwareId+'</b></h6>';
              newcard += '<button class="btn btn-primary m-2 select-button" ip="'+item.ip+'" model="'+item.Model+'" scheme="'+item.urlscheme+'" type="button">Select this</button>';
            newcard += '</div>';
          newcard += '</div>';
          $('#netlist').append(newcard);
        };
        $('.select-button').click(function() {
          $('#netlist').empty();
          $('#userinput').val('CAM_AI');
          $('#passinput').val('easy123');
          $('#typespan').text($(this).attr('model'));
          urlscheme = $(this).attr('scheme')
          $('#ipaddress').val($(this).attr('ip'));
          $('#userinput').trigger("change");
        });
      })
      .catch(err => {console.log(err);});
    });

    $('.check-button').click(function() {
      $('.check-button').addClass('btn-warning');
      $('#search_result').addClass("d-none");
      $('#codecdiv').addClass("d-none");
      admintoolsSocket.sendandwait({
        'command' : 'scanoneip',
        'camurl' : $('#camurl').val(),
        'user' : $('#userinput').val(),
        'pass' : $('#passinput').val(),
        'onvif' : 1,
      })  
      .then((result) => {
        $('.check-button').removeClass('btn-warning');
        if(Object.keys(result).length === 0) {
          $('#search_result').text("We did not get a proper response. Either the URL is wrong or the system on this address is not a camera.");
          $('#search_result').removeClass("d-none");
        } else {
          $('#codecdiv').removeClass("d-none");
          firstvideooption = true;
          firstaudiooption = true;
          $('#videoselect').empty();
          $('#audioselect').empty();
          xresolutions = [];
          yresolutions = [];
          for (item of result.streams) {
            if (item.codec_type == 'video') {
              newoption = '<option value="' + item.index + '"';
              if (firstvideooption) {
                newoption += ' selected';
                firstvideooption = false;
              };
              newoption += ('>' + item.codec_name + ' / ' 
                + item.coded_width + 'x' 
                + item.coded_height + ' / '
                + eval(item.r_frame_rate) + 'fps' 
                + '</option>');
              $('#videoselect').append(newoption);
              xresolutions[item.index] = item.coded_width;
              yresolutions[item.index] = item.coded_height;
            };
            if (item.codec_type == 'audio') {
              newoption = '<option value="' + item.index + '"';
              if (firstaudiooption) {
                newoption += ' selected';
                firstaudiooption = false;
              };
              newoption += ('>' + item.codec_name + ' / ' 
                + item.channel_layout + ' / '
                + item.sample_rate + 'sps' 
                + '</option>');
              $('#audioselect').append(newoption);
            };
          };
        };
      })
      .catch(err => {console.log(err);});
    });
    $('.install-button').click(function() {
      $('.install-button').addClass('btn-warning');
      admintoolsSocket.sendandwait({
        'command' : 'installcam',
        'camurl' : $('#camurl').val(),
        'videocodec' : $('#videoselect').val(),
        'audiocodec' : $('#audioselect').val(),
        'xresolution' : xresolutions[$('#videoselect').val()],
        'yresolution' : yresolutions[$('#videoselect').val()],
        'name' : $('#typespan').text(),
      })  
      .then((result) => {
        $('.install-button').removeClass('btn-warning');
        window.location.href = window.location.protocol + '//' + window.location.host;
      })
      .catch(err => {console.log(err);});
    });
  })  
  .catch(err => {console.log(err);});
});
</script>
{% else %}
  <div class="h2 m-2">
  You can create {{ streamlimit }} camera streams.<br>
  You already have {{ streamcount }}.<br>
  Please delete one or more to create a new one...
  </div>
{% endif %}

{% endblock %}
