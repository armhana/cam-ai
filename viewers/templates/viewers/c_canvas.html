<div>
    <h1>{{ name }}{{ myurl }}</h1>
		<h5>{{ xres }}x{{ yres }}, fps = <span id="fpstag{{ mode }}{{ idx }}">?</span>, views = <span id="vnrtag{{ mode }}{{ idx }}">?</span></h5>
		{% if mode == "C" %}
      {% if dmode ==  "L" %} 
    <canvas id="canvas{{ mode }}{{ idx }}" width="{{ width }}px" height="{{ height }}"></canvas>
      {% else %}
    <a href="/oneitem/cam/{{ idx }}/"><canvas id="canvas{{ mode }}{{ idx }}" width="{{ width }}px" height="{{ height }}"></canvas></a>
		  {% endif %}
		{% endif %}
		{% if mode == "D" %}
      {% if dmode ==  "L" %} 
    <canvas id="canvas{{ mode }}{{ idx }}" width="{{ width }}px" height="{{ height }}"></canvas>
      {% else %}
    <a href="/oneitem/detector/{{ idx }}/"><canvas id="canvas{{ mode }}{{ idx }}" width="{{ width }}px" height="{{ height }}"></canvas></a>
		  {% endif %}
		{% endif %}
		{% if mode == "E" %}
    <a href="/oneitem/eventer/{{ idx }}/"><canvas id="canvas{{ mode }}{{ idx }}" width="{{ width }}px" height="{{ height }}px" /></a>
		{% endif %}
</div>
<script >

let wait{{ mode }}{{ idx }} = 0;
let canvas{{ mode }}{{ idx }} = document.getElementById("canvas{{ mode }}{{ idx }}");
let ctx{{ mode }}{{ idx }} = canvas{{ mode }}{{ idx }}.getContext("2d");

function timedRefresh{{ mode }}{{ idx|stringformat:"09d" }}(bytebuffer) {
  if (wait{{ mode }}{{ idx }} == 0) {
    wait{{ mode }}{{ idx }} = 1;
    UI8Carray = new Uint8ClampedArray(bytebuffer, 10); //10 is offset
    ImageSource = new ImageData(UI8Carray, {{ width }}, {{ height }});
    ctx{{ mode }}{{ idx }}.putImageData(ImageSource, 0, 0);  
    wait{{ mode }}{{ idx }} = 0;
  };
};

r_array['{{ mode }}{{ idx|stringformat:"09d" }}'] = timedRefresh{{ mode }}{{ idx|stringformat:"09d" }};

trigger_Socket.sendandwait({
	'command' : 'starttrigger',
	'mode' : '{{ mode }}',
  'idx' : {{ idx }},
  'width' : {{ width }},
  'height' : {{ height }},
});
setInterval(() => {
  c_view_Socket.sendandwait({
    'command' : 'getcaminfo',
    'mode' : '{{ mode }}',
    'idx' : {{ idx }},
  })
  .then((result) => {
    $('#fpstag{{ mode }}{{ idx }}').text(result.fps);
    $('#vnrtag{{ mode }}{{ idx }}').text(result.viewers);
  })
  .catch(err => {console.log(err);});
}, 5000);

</script>
