{% extends 'main/basis.html' %}
{% block content %}
    {% if emulatestatic %}
    {% load static %}
    <script src="{% static 'camai/git/js/wstools.js' %}"></script>
    <script src="{% static 'camai/nogit/js/jquery-3.5.1.js' %}"></script>
    {% else %}
    <script src="https://static.cam-ai.de/{{ version }}/camai/git/js/wstools.js"></script>
    <script src="https://static.cam-ai.de/{{ version }}/camai/nogit/js/jquery-3.5.1.min.js"></script>
    {% endif %}
		<div class="container-fluid float-left">
			<div class="row">
			{% spaceless %}
        {% if mode == 'C' %}
				  {% for item in camlist %} 
						<div class="col-sm-auto">
							<div id="spaceforcanvas{{ mode }}{{ item.id }}"></div>
						</div>
				  {% endfor %}
				{% endif %}
        {% if mode == 'D' %}
				  {% for item in detectorlist %} 
						<div class="col-sm-auto">
							<div id="spaceforcanvas{{ mode }}{{ item.id }}"></div>
						</div>
				  {% endfor %}
				{% endif %}
        {% if mode == 'E' %}
				  {% for item in eventerlist %} 
						<div class="col-sm-auto">
							<div id="spaceforcanvas{{ mode }}{{ item.id }}"></div>
						</div>
				  {% endfor %}
				{% endif %}
			{% endspaceless %}
			</div>
		</div>
<script >

let ws_scheme = window.location.protocol == "https:" ? "wss:" : "ws:";
let c_view_Socket;
let trigger_Socket;
let r_array = {};
let displaywidth = 375 // Screen width IPhone 7

$(document).ready(function() {
	WSAsync(ws_scheme+'//'+window.location.host+'/ws/c_view/')
	.then((result) => {
		c_view_Socket = result;
    return(WSAsync(ws_scheme+'//'+window.location.host+'/ws/trigger/'));
  })
	.then((result) => {
    trigger_Socket = result;
		trigger_Socket.socket.onclose = function(e) {
			console.log('Trigger-Socket closed');
		};
		trigger_Socket.socket.onmessage = function(e) {
      if (typeof(e.data) === 'object') {
        e.data.arrayBuffer()
        .then((bytebuffer) => {
          miniarray = new Uint8Array(bytebuffer, 0, 10);
				  vnr = String.fromCharCode.apply(null, miniarray);
				  if (vnr in r_array) {
					  r_array[vnr](bytebuffer);
				  };
          trigger_Socket.socket.send(vnr);
        })
        .catch(err => {console.log(err);});
			};
		};
		{% spaceless %}
    {% if mode == 'C' %}
		  {% for item in camlist %} 
        ratio = ({{ item.cam_yres }} / {{ item.cam_xres }});
        $.get('/viewers/c_canvas/S/C/{{ item.id }}/'+displaywidth+'/'+Math.round(displaywidth * ratio), function(data) {
					$('#spaceforcanvasC{{ item.id }}').html(data);
				});
		  {% endfor %}
		{% endif %}
    {% if mode == 'D' %}
		  {% for item in detectorlist %} 
        ratio = ({{ item.cam_yres }} / {{ item.cam_xres }});
        $.get('/viewers/c_canvas/S/D/{{ item.id }}/'+displaywidth+'/'+Math.round(displaywidth * ratio), function(data) {
					$('#spaceforcanvasD{{ item.id }}').html(data);
				});
		  {% endfor %}
		{% endif %}
    {% if mode == 'E' %}
		  {% for item in eventerlist %} 
        ratio = ({{ item.cam_yres }} / {{ item.cam_xres }});
        $.get('/viewers/c_canvas/S/E/{{ item.id }}/'+displaywidth+'/'+Math.round(displaywidth * ratio), function(data) {
					$('#spaceforcanvasE{{ item.id }}').html(data);
				});
		  {% endfor %}
		{% endif %}
		{% endspaceless %}
	})
	.catch(err => {console.log(err);});

});
	
</script>
{% endblock %}

